<div id="quizRoot">
    <div class="quiz-content">
        <div class="page-header">
            <div class="welcome-section">
                <h2>{{ currentTheme?.emoji }} AI Kviz</h2>
                <p>Testiraj svoje znanje sa AI-generiranim pitanjima</p>
            </div>
            <div class="header-actions">
                <button (click)="toggleStatsPanel()" class="btn-stats">ğŸ“Š Statistika</button>
                <button routerLink="/fun-zone" class="btn-settings">â¬…ï¸ Fun Zone</button>
                <button (click)="logout()" class="btn-logout">ğŸšª Odjava</button>
            </div>
        </div>

        <!-- Setup Screen -->
        <div class="setup-screen" *ngIf="showSetup">
            <div class="setup-card">
                <h3>ğŸ¯ Kreiraj svoj kviz</h3>

                <div class="ai-status-banner">
                    <div class="ai-status-icon">ğŸ¤–</div>
                    <div class="ai-status-text">
                        <span class="ai-status-title">âœ… AI Povezan</span>
                        <span class="ai-status-subtitle">Pitanja se generiÅ¡u automatski putem OpenRouter AI</span>
                    </div>
                </div>

                <!-- Topic Selection -->
                <div class="setup-section">
                    <label>ğŸ“š Odaberi teme (jedna ili viÅ¡e):</label>
                    <div class="topics-grid">
                        <button *ngFor="let topic of availableTopics" class="topic-btn"
                            [class.selected]="isTopicSelected(topic.id)" (click)="toggleTopic(topic.id)">
                            {{ topic.emoji }} {{ topic.name }}
                        </button>
                    </div>
                </div>

                <!-- Difficulty Selection -->
                <div class="setup-section">
                    <label>ğŸ“Š TeÅ¾ina:</label>
                    <div class="difficulty-options">
                        <button class="difficulty-btn" [class.selected]="selectedDifficulty === 'easy'"
                            (click)="selectedDifficulty = 'easy'">
                            ğŸŸ¢ Lagano
                        </button>
                        <button class="difficulty-btn" [class.selected]="selectedDifficulty === 'medium'"
                            (click)="selectedDifficulty = 'medium'">
                            ğŸŸ¡ Srednje
                        </button>
                        <button class="difficulty-btn" [class.selected]="selectedDifficulty === 'hard'"
                            (click)="selectedDifficulty = 'hard'">
                            ğŸ”´ TeÅ¡ko
                        </button>
                    </div>
                </div>

                <!-- Number of Questions -->
                <div class="setup-section">
                    <label>ğŸ”¢ Broj pitanja:</label>
                    <div class="questions-options">
                        <button *ngFor="let num of [3, 5, 7, 10]" class="num-btn"
                            [class.selected]="numberOfQuestions === num" (click)="numberOfQuestions = num">
                            {{ num }}
                        </button>
                    </div>
                </div>

                <!-- Error Message -->
                <div class="error-message" *ngIf="generationError">
                    âš ï¸ {{ generationError }}
                </div>

                <!-- Generate Button -->
                <button class="btn-generate" (click)="generateQuiz()"
                    [disabled]="isGenerating || selectedTopics.length === 0">
                    ğŸš€ GeneriÅ¡i kviz
                </button>

                <p class="selected-info" *ngIf="selectedTopics.length > 0">
                    Odabrano: {{ getSelectedTopicsNames() }}
                </p>
            </div>
        </div>

        <!-- Quiz Form -->
        <form class="quiz-form" *ngIf="!showSetup && questions.length > 0" (submit)="$event.preventDefault()">
            <div class="quiz-info">
                <span>ğŸ“š {{ getSelectedTopicsNames() }}</span>
                <span>ğŸ“Š {{ selectedDifficulty === 'easy' ? 'Lagano' : selectedDifficulty === 'medium' ? 'Srednje' :
                    'TeÅ¡ko' }}</span>
                <span>ğŸ”¢ {{ questions.length }} pitanja</span>
            </div>

            <div *ngFor="let question of questions; let qIndex = index" class="question-card"
                [class.correct]="question.isCorrect === true" [class.incorrect]="question.isCorrect === false">
                <div class="question-number">Pitanje {{ qIndex + 1 }}</div>
                <h3>{{ question.text }}</h3>

                <div class="answers-container" *ngIf="question.type === 'radio'">
                    <label *ngFor="let answer of question.answers" class="answer-option"
                        [class.selected]="isChecked(question, answer.value)">
                        <input type="radio" [name]="question.id" [value]="answer.value"
                            [checked]="isChecked(question, answer.value)"
                            (change)="onRadioChange(question, answer.value)" />
                        <span class="custom-radio"></span>
                        <span class="answer-text">{{ answer.label }}</span>
                    </label>
                </div>

                <div class="answers-container" *ngIf="question.type === 'checkbox'">
                    <label *ngFor="let answer of question.answers" class="answer-option"
                        [class.selected]="isChecked(question, answer.value)">
                        <input type="checkbox" [name]="question.id" [value]="answer.value"
                            [checked]="isChecked(question, answer.value)"
                            (change)="onCheckboxChange(question, answer.value, $any($event.target).checked)" />
                        <span class="custom-checkbox"></span>
                        <span class="answer-text">{{ answer.label }}</span>
                    </label>
                </div>
            </div>

            <div class="quiz-actions">
                <button class="btn" (click)="checkAnswers()" *ngIf="!showResult">âœ… Provjeri odgovore</button>
                <button class="btn btn-secondary" (click)="backToSetup()">â¬…ï¸ Novi kviz</button>
            </div>

            <div class="result" [class.visible]="showResult">
                Rezultat: <strong>{{ score }}</strong> / {{ maxScore }}
                ({{ maxScore > 0 ? ((score / maxScore) * 100).toFixed(0) : 0 }}%)
            </div>
            <button *ngIf="showResult" class="btn" (click)="restart()">ğŸ”„ Ponovo isti kviz</button>
        </form>
    </div>
</div>

<!-- Quiz Perfect Score Overlay -->
<div class="modal-overlay" [class.visible]="showPerfectOverlay" role="dialog" aria-modal="true"
    aria-labelledby="quizPerfectTitle">
    <div class="modal-card">
        <button class="modal-close-btn" type="button" aria-label="Zatvori" (click)="closePerfectOverlay()">Ã—</button>
        <h2 id="quizPerfectTitle">ğŸ‰ SavrÅ¡en rezultat!</h2>
        <p id="quizPerfectMsg">Odgovorili ste taÄno na sva pitanja. Sjajan posao!</p>
        <div class="modal-actions">
            <button type="button" (click)="backToSetup()">Novi kviz</button>
            <button type="button" (click)="restart()">Ponovo</button>
            <button type="button" (click)="closePerfectOverlay()">Nastavi</button>
        </div>
    </div>
</div>

<!-- Stats Panel -->
<div class="stats-panel" [class.visible]="showStatsPanel">
    <div class="stats-card">
        <button class="stats-close-btn" type="button" aria-label="Zatvori" (click)="toggleStatsPanel()">Ã—</button>
        <h3>ğŸ“Š Tvoja Kviz Statistika</h3>

        <div class="stats-loading" *ngIf="!stats">
            <span>UÄitavanje...</span>
        </div>

        <div class="stats-grid" *ngIf="stats">
            <div class="stat-item">
                <span class="stat-value">{{ stats.totalQuizzes }}</span>
                <span class="stat-label">Odigranih kvizova</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">{{ getAverageScore() }}%</span>
                <span class="stat-label">ProsjeÄni rezultat</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">{{ stats.bestScore }}%</span>
                <span class="stat-label">Najbolji rezultat</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">{{ stats.correctAnswers }}/{{ stats.totalQuestions }}</span>
                <span class="stat-label">TaÄnih odgovora</span>
            </div>
            <div class="stat-item wide">
                <span class="stat-value">{{ stats.topicsPlayed.length || 0 }}</span>
                <span class="stat-label">RazliÄitih tema</span>
            </div>
        </div>

        <div class="difficulty-stats" *ngIf="stats">
            <h4>Po teÅ¾ini:</h4>
            <div class="diff-row">
                <span>ğŸŸ¢ Lagano:</span> <strong>{{ stats.quizzesByDifficulty.easy || 0 }}</strong>
            </div>
            <div class="diff-row">
                <span>ğŸŸ¡ Srednje:</span> <strong>{{ stats.quizzesByDifficulty.medium || 0 }}</strong>
            </div>
            <div class="diff-row">
                <span>ğŸ”´ TeÅ¡ko:</span> <strong>{{ stats.quizzesByDifficulty.hard || 0 }}</strong>
            </div>
        </div>

        <p class="stats-note" *ngIf="stats?.totalQuizzes === 0">
            Odigraj prvi kviz da poÄneÅ¡ skupljati statistiku! ğŸ®
        </p>
    </div>
</div>

<!-- Loading Overlay with Did You Know -->
<div class="quiz-loading-overlay" *ngIf="isGenerating">
    <div class="loading-card">
        <div class="loading-emoji">ğŸ§ </div>
        <h2 class="loading-title">GeneriÅ¡e se kviz...</h2>
        <p class="loading-subtitle">AI priprema pitanja za tebe</p>

        <div class="did-you-know">
            <div class="dyk-header">
                <span>ğŸ’¡</span>
                <span>Jesi li znao/la?</span>
            </div>
            <p class="dyk-text">{{ currentDidYouKnow }}</p>
        </div>

        <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
</div>
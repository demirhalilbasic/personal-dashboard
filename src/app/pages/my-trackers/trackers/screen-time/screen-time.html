<div class="tracker-container">
    <div class="tracker-content">
        <div class="tracker-header">
            <div class="header-left">
                <button class="btn-back" routerLink="/my-trackers">â† Nazad</button>
                <div class="tracker-title" *ngIf="tracker">
                    <span class="tracker-icon" [style.backgroundColor]="tracker.color + '20'">{{ tracker.icon }}</span>
                    <div class="title-text">
                        <h1>{{ tracker.name }}</h1>
                        <p>{{ tracker.description }}</p>
                    </div>
                </div>
            </div>
            <div class="header-stats">
                <div class="stat-item"><span class="stat-icon">ğŸ”¥</span><span class="stat-value">{{ streak
                        }}</span><span class="stat-label">streak</span></div>
                <div class="stat-item"><span class="stat-icon">ğŸ“Š</span><span class="stat-value">{{ weeklyProgress
                        }}%</span><span class="stat-label">sedmica</span></div>
            </div>
        </div>

        <!-- Date Selector -->
        <div class="date-section">
            <button class="date-picker-btn" (click)="toggleDatePicker()">
                <span class="date-icon">ğŸ“…</span>
                <span class="date-text">{{ formatDateShort(selectedDate) }}</span>
                <span class="date-arrow">â–¼</span>
            </button>

            <!-- Date Picker Popup -->
            <div class="date-picker-popup" *ngIf="showDatePicker">
                <div class="date-option" *ngFor="let date of dateOptions" [class.active]="selectedDate === date"
                    [class.today]="isToday(date)" (click)="selectDate(date)">
                    <span class="date-day">{{ getDayName(date) }}</span>
                    <span class="date-full">{{ formatDateShort(date) }}</span>
                    <span class="date-badge" *ngIf="isToday(date)">Danas</span>
                </div>
            </div>
        </div>

        <!-- Popup Overlay -->
        <div class="date-picker-overlay" *ngIf="showDatePicker" (click)="closeDatePicker()"></div>

        <div class="loading" *ngIf="isLoading">
            <div class="spinner"></div>
            <p>UÄitavanje...</p>
        </div>

        <div class="main-content" *ngIf="!isLoading">
            <div class="usage-overview">
                <div class="usage-circle">
                    <svg viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#e0e0e0" stroke-width="8" />
                        <circle cx="50" cy="50" r="45" fill="none" [attr.stroke]="getUsageColor()" stroke-width="8"
                            [style.strokeDasharray]="283"
                            [style.strokeDashoffset]="283 - (283 * getUsagePercentage() / 100)" stroke-linecap="round"
                            transform="rotate(-90 50 50)" />
                    </svg>
                    <div class="usage-text">
                        <span class="usage-value">{{ formatMinutes(getTotalMinutes()) }}</span>
                        <span class="usage-label">/ {{ formatMinutes(dailyLimit) }}</span>
                    </div>
                </div>
                <div class="usage-info">
                    <div class="info-item" [class.over-limit]="getTotalMinutes() > dailyLimit">
                        <span class="info-icon">{{ getTotalMinutes() > dailyLimit ? 'âš ï¸' : 'âœ…' }}</span>
                        <span>{{ getTotalMinutes() > dailyLimit ? 'PrekoraÄen limit!' : 'U granicama limita' }}</span>
                    </div>
                    <div class="limit-setting">
                        <label>Dnevni limit:</label>
                        <input type="number" [(ngModel)]="dailyLimit" min="30" step="30" (change)="saveData()">
                        <span>min</span>
                    </div>
                </div>
            </div>

            <div class="category-breakdown" *ngIf="getCategoryBreakdown().length > 0">
                <h3>ğŸ“Š Po kategorijama</h3>
                <div class="category-list">
                    <div class="category-item" *ngFor="let cat of getCategoryBreakdown()">
                        <div class="category-info">
                            <span class="category-label">{{ getCategoryLabel(cat.category) }}</span>
                            <span class="category-time">{{ formatMinutes(cat.minutes) }}</span>
                        </div>
                        <div class="category-bar">
                            <div class="category-fill" [style.width.%]="cat.percentage"
                                [style.backgroundColor]="getCategoryColor(cat.category)"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="add-usage-section">
                <h3>â• Dodaj koriÅ¡tenje</h3>
                <div class="usage-form">
                    <div class="form-group">
                        <label>Kategorija</label>
                        <select [(ngModel)]="newUsage.category">
                            <option value="">Odaberi...</option>
                            <option *ngFor="let cat of categories" [value]="cat.value">{{ cat.label }}</option>
                        </select>
                    </div>
                    <div class="form-group flex-2">
                        <label>Aplikacija / Aktivnost</label>
                        <input type="text" [(ngModel)]="newUsage.app" placeholder="Npr. Instagram, YouTube...">
                    </div>
                    <div class="form-group">
                        <label>Trajanje (min)</label>
                        <input type="number" [(ngModel)]="newUsage.minutes" min="1">
                    </div>
                    <button class="btn-add" (click)="addUsage()">+ Dodaj</button>
                </div>
            </div>

            <div class="usages-section">
                <h3>ğŸ“± Dnevno koriÅ¡tenje</h3>
                <div class="usages-list" *ngIf="appUsages.length > 0">
                    <div class="usage-item" *ngFor="let u of appUsages; trackBy: trackById"
                        [style.borderLeftColor]="getCategoryColor(u.category)">
                        <span class="usage-app">{{ u.app }}</span>
                        <span class="usage-category">{{ getCategoryLabel(u.category) }}</span>
                        <span class="usage-duration">{{ formatMinutes(u.minutes) }}</span>
                        <button class="btn-remove" (click)="removeUsage(u.id)">âœ•</button>
                    </div>
                </div>
                <div class="empty-state" *ngIf="appUsages.length === 0">
                    <span>ğŸ“±</span>
                    <p>Nema unesenog koriÅ¡tenja za ovaj dan</p>
                </div>
            </div>

            <div class="chart-section">
                <h3>ğŸ“ˆ SedmiÄni pregled</h3>
                <div class="weekly-chart">
                    <div class="chart-bar-group" *ngFor="let d of weeklyData">
                        <div class="bar-container">
                            <div class="bar" [style.height.%]="(d.minutes / getMaxWeeklyMinutes()) * 100"
                                [class.over-limit]="d.minutes > dailyLimit"></div>
                        </div>
                        <span class="bar-label">{{ d.day }}</span>
                    </div>
                </div>
                <div class="limit-line" [style.bottom.%]="(dailyLimit / getMaxWeeklyMinutes()) * 100">
                    <span>Limit</span>
                </div>
            </div>

            <button class="btn-save" (click)="saveData()" [disabled]="isSaving">
                {{ isSaving ? 'ğŸ’¾ Spremanje...' : 'ğŸ’¾ Spremi' }}
            </button>
        </div>

        <div class="saving-indicator" *ngIf="isSaving"><span>ğŸ’¾ Spremanje...</span></div>
    </div>
</div>